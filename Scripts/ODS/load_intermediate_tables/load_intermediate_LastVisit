---Load_LatestVisit
With LatestVisit AS (
SELECT distinct row_number() OVER (PARTITION BY PatientID ,SiteCode,PatientPK ORDER BY VisitDate DESC) AS NUM,
    PatientID ,
    SiteCode,
    PatientPK,
    VisitDate as LastVisitDate,
CASE WHEN NextAppointmentDate IS NULL THEN DATEADD(dd,30,VisitDate) ELSE NextAppointmentDate End AS NextAppointment 

FROM ODS.dbo.CT_PatientVisits
 )
 Select LatestVisit.* INTO NDWH.dbo.Intermediate_LastVisitDate
 from LatestVisit
 where NUM=1







