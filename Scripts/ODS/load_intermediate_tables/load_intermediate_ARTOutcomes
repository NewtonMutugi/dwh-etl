
With ARTOutcomes AS (

Select
DISTINCT 
    Patients.PatientID, 
    Patients.PatientPK,
    ART.startARTDate,
    YEAR(ART.startARTDate) AS Cohort,
    Exits.ExitReason,
    Exits.ExitDate,
    LE.[LastEncounterDate],
    LE.[NextAppointmentDate],
	CASE WHEN ISNULL(LE.LastEncounterDate, ART.LastVisit) <= GETDATE()  
	THEN
	(CASE 
				WHEN  Exits.ExitDate IS NOT NULL and Exits.ExitReason<>'DIED' and coalesce(Exits.EffectiveDiscontinuationDate, le.NextAppointmentDate) > EOMONTH(DATEADD(mm,-1,GETDATE()))  THEN 'V'--When a TO and LFTU has an discontinuationdate > Last day of Previous month 
				When Exits.ExitDate IS NOT NULL and Exits.ExitReason<>'DIED' and Exits.ReEnrollmentDate between  DATEADD(MONTH, DATEDIFF(MONTH, 0, GETDATE())-1, 0) and DATEADD(MONTH, DATEDIFF(MONTH, -1, GETDATE())-1, -1) THEN 'V'
			    When Exits.ExitDate >EOMONTH(DATEADD(mm,-1,GETDATE())) and Exits.ExitReason='DIED' THEN 'V'
				WHEN Exits.ExitDate IS NOT NULL THEN SUBSTRING(Exits.ExitReason,1,1)--When exit date is available then Inserts the exit reasons , Extracts 1 character from Exit reasons starting from position 1
				WHEN ART.startARTDate> DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,GETDATE()),0)) THEN 'NP'-- When StartARTDate is after Last Day of Previous EOM 
			    WHEN EOMONTH(DATEADD(mm,-1,GETDATE())) < ISNULL(le.NextAppointmentDate,ART.ExpectedReturn)-- When last day of previous month is less than TCA
			    OR DATEDIFF( dd, ISNULL(le.NextAppointmentDate,ART.ExpectedReturn), EOMONTH(DATEADD(mm,-1,GETDATE()))) <=30 THEN 'V'-- Date diff btw TCA  and LAst day of Previous month-- must not be late by 30 days
			    WHEN DATEDIFF( dd, ISNULL(le.NextAppointmentDate,ART.ExpectedReturn), EOMONTH(DATEADD(mm,-1,GETDATE()))) >30 THEN 'uL'--Date diff btw TCA  and Last day of Previous month
			    WHEN le.NextAppointmentDate IS NULL and ART.ExpectedReturn IS NULL THEN 'NV'

			END
		)
	ELSE 'FV' END 
AS ARTOutcome, 
    Patients.SiteCode,
    Patients.Emr,
     Patients.Project, 
     SD.SiteAbstractionDate,
     DU.DateUploaded
     
FROM ODS.dbo.CT_Patient Patients
INNER JOIN ODS.dbo.CT_ARTPatients  ART  ON Patients.PatientID = ART.PatientID AND Patients.PatientPK=ART.PatientPK and Patients.Sitecode=ART.Sitecode
LEFT JOIN [dbo].[vw_LastPatientEncounter] LE ON  Patients.PatientID = LE.PatientID AND Patients.PatientPK=LE.PatientPK AND Patients.SiteCode = LE.SiteCode
LEFT JOIN [ODS].dbo.CT_PatientStatus Exits   ON  Patients.PatientID = Exits.PatientID AND Patients.PatientPK=Exits.PatientPK  and Patients.Sitecode=Exits.Sitecode

  WHERE  ART.startARTDate IS NOT NULL 
),
LatestUpload AS (
select 
    SiteCode,
    Max(DateRecieved) As DateUploaded
 from DWAPICentral.dbo.FacilityManifest
  group by SiteCode
),

LatestVisits AS (
    Select 
    distinct sitecode,
     Max(Visitdate) As SiteAbstractionDate
     from ODS.dbo.CT_PatientVisits
     group by SiteCode
     
)
Select ARTOutcomes.*,
  LatestUploaExits.DateUploaded
 from ARTOutcomes
 left join LatestUpload ON LatestUploaExits.SiteCode = ARTOutcomes.SiteCode 
left  join  LatestVisits  ON  LatestVisits.SiteCode = ARTOutcomes.SiteCode
