With PharmacyDispenseAsAtDate AS (
SELECT distinct row_number() OVER (PARTITION BY PatientID ,SiteCode,PatientPK ORDER BY DispenseDate DESC) AS NUM,
    PatientID ,
    SiteCode,
    PatientPK,
    DispenseDate as LastDispenseDate,
CASE WHEN ExpectedReturn IS NULL THEN DATEADD(dd,30,DispenseDate) ELSE ExpectedReturn End AS ExpectedReturn 
FROM ODS.dbo.CT_PatientPharmacy
 )
 Select PharmacyDispenseAsAtDate.* INTO NDWH.dbo.Intermediate_PharmacyDispenseAsAtDate
 from PharmacyDispenseAsAtDate
 where NUM=1 and  LastDispenseDate<=EOMONTH(DATEADD(mm,-1,GETDATE())) 